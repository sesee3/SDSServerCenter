<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessioni - Sistema Autenticazione</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/scripts/common.js" defer></script>
</head>
<body class="requires-auth">
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div>
                    <a href="/user/dashboard" class="sidebar-brand">SDS Portal</a>
                    <span class="sidebar-subtitle">Console amministrativa</span>
                </div>
                <button class="sidebar-toggle" data-sidebar-toggle aria-label="Comprimi sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="8 4 16 12 8 20"></polyline>
                    </svg>
                </button>
            </div>
            <div class="sidebar-user">
                <span class="sidebar-user-label">Utente</span>
                <span class="sidebar-user-name" id="currentUser" data-username></span>
            </div>
            <nav class="sidebar-nav">
                <a href="/user/dashboard" class="sidebar-link" data-nav-target="/user/dashboard">Dashboard</a>
                <a href="/user/sessions" class="sidebar-link" data-nav-target="/user/sessions">Sessioni</a>
                <a href="/server/activities" class="sidebar-link" data-nav-target="/server/activities">Attivit√†</a>
                <a href="/conferences" class="sidebar-link" data-nav-target="/conferences">Conferenze</a>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-switcher-custom">
                    <button id="themeAuto" class="theme-icon active" onclick="setTheme('auto')" title="Tema automatico">
                        <svg width="18" height="18" viewBox="0 0 71 90" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.34961 89.5254C2.12695 89.5254 0 87.6562 0 84.6914C0 83.4023 0.322266 82.1777 0.837891 80.6309L27.3281 6.57422C28.9395 2.0625 31.1953 0 35.3203 0C39.4453 0 41.7012 2.0625 43.3125 6.57422L69.8027 80.6309C70.3184 82.0488 70.6406 83.4023 70.6406 84.627C70.6406 87.6562 68.5137 89.5254 65.2266 89.5254C62.1328 89.5254 60.3926 88.043 59.168 84.2402L51.7559 62.2617H18.8203L11.4082 84.2402C10.1836 88.1074 8.44336 89.5254 5.34961 89.5254ZM21.8496 53.1738H48.7266L35.5137 13.9863H35.0625L21.8496 53.1738Z" />
                        </svg>
                    </button>
                    <button id="themeLight" class="theme-icon" onclick="setTheme('light')" title="Tema chiaro">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                    <button id="themeDark" class="theme-icon" onclick="setTheme('dark')" title="Tema scuro">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </div>
                <button class="btn btn-secondary btn-sm btn-block" onclick="logout()">Logout</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="page-topbar">
                <button class="sidebar-toggle" data-sidebar-toggle aria-label="Mostra menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="topbar-actions">
                    <h1>Sessioni</h1>
                </div>
            </div>
            <div class="content-area">
                <header class="page-header">
                    <div>
                        <h2>Sessioni attive del tuo account</h2>
                        <p>Controlla e termina le sessioni connesse.</p>
                    </div>
                </header>

                <div id="sessions"></div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = requireAuth();
            if (!user) {
                return;
            }

            document.querySelectorAll('[data-username]').forEach(el => {
                el.textContent = user.username;
            });

            initLayout();
            loadSessions();
        });

        async function loadSessions() {
            const token = getToken();
            if (!token) {
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/sessions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    await handleApiError(response);
                    return;
                }

                const sessions = await response.json();
                displaySessions(sessions);
            } catch (error) {
                console.error('Errore nel caricamento delle sessioni', error);
                showAlert('Impossibile caricare le sessioni al momento.', 'error');
            }
        }

        function displaySessions(sessions) {
            const container = document.getElementById('sessions');
            container.innerHTML = '';

            if (!sessions.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Nessuna sessione attiva trovata.</p>
                    </div>
                `;
                return;
            }

            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'session';

                const date = formatDateTime(session.lastAccessAt);

                sessionEl.innerHTML = `
                    <div class="session-info">
                        <h3>
                            ${escapeHtml(session.deviceInfo.device)} - ${escapeHtml(session.deviceInfo.browser)}
                            ${session.isCurrent ? '<span class="current-badge">Corrente</span>' : ''}
                        </h3>
                        <p>Sistema operativo: ${escapeHtml(session.deviceInfo.os)}</p>
                        <p>IP: ${escapeHtml(session.ipAddress)}</p>
                        <p>Ultimo accesso: ${date}</p>
                    </div>
                    <button class="btn btn-danger btn-sm" ${session.isCurrent ? 'disabled' : ''}
                            onclick="deleteSession('${session.id}')">
                        ${session.isCurrent ? 'Sessione Corrente' : 'Elimina'}
                    </button>
                `;

                container.appendChild(sessionEl);
            });
        }

        async function deleteSession(sessionId) {
            if (!confirm('Sei sicuro di voler eliminare questa sessione?')) {
                return;
            }

            const token = getToken();

            try {
                const response = await fetch(`/api/v1/auth/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    await handleApiError(response);
                    return;
                }

                showAlert('Sessione rimossa correttamente.', 'success');
                loadSessions();
            } catch (error) {
                console.error('Errore nell\'eliminazione della sessione', error);
                showAlert('Impossibile eliminare la sessione.', 'error');
            }
        }
    </script>
</body>
</html>
